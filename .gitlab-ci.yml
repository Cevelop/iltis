variables:
  LC_ALL: "C.UTF-8"
  LANG: "en_US.UTF-8"
  LANGUAGE: "en_US.UTF-8"
  MAVEN_OPTS: "-Dmaven.repo.local=./.m2/repository"

stages:
  - build-test
  - deploy

image: fmorgner/cevelop-plugin-build:latest

before_script:
  - cd ILTISCppProject
      
build-test:
  stage: build-test
  cache:
    key: "ILTISCppMavenCache"
    paths:
      - ./*/.m2/repository
    policy: pull
  script:
    - 'xvfb-run --server-args="-screen 0 1024x768x24" mvn verify -Djarsigner.skip=true'
  artifacts:
    paths:
      - ./*/*/*/target/repository/**

deploy:
  stage: deploy
  script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$P2_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo "$P2_HOST_KEY" > ~/.ssh/known_hosts'
    - 'ssh hudson@cute-test.com "cd /var/www/iltis && mkdir -p cpp"'
    - 'scp -r releng/ch.hsr.ifs.iltis.cpp.update/target/repository/* hudson@cute-test.com:/var/www/iltis/cpp'
    - 'ssh hudson@cute-test.com "cd /var/www/iltis && compile-composite-updatesite ILTIS 1.0.0"'