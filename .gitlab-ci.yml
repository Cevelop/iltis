variables:
  LC_ALL: "C.UTF-8"
  LANG: "en_US.UTF-8"
  LANGUAGE: "en_US.UTF-8"
  MAVEN_OPTS: "-Dmaven.repo.local=./.m2/repository"

image: fmorgner/cevelop-plugin-build:latest

build:
  stage: build
  cache:
    key: "ILTISTestingeMavenCache"
    paths:
      - ./.m2/repository
  script:
    - cd ILTISTestingProject
    - mvn compile
  artifacts:
    paths:
      - ./**/target/*

test:
  stage: test
  cache:
    key: "ILTISTestingMavenCache"
    paths:
      - ./.m2/repository
    policy: pull
  script:
    - cd ILTISTestingProject
    - 'xvfb-run --server-args="-screen 0 1024x768x24" mvn test verify -Djarsigner.skip=true'
  artifacts:
    paths:
      - ./ch.hsr.ifs.iltis.testing.update/target/repository/*

deploy:
  stage: deploy
  cache:
    key: "ILTISTestingMavenCache"
    paths:
      - ./.m2/repository
    policy: pull
  script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$P2_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo "$P2_HOST_KEY" > ~/.ssh/known_hosts'
    - 'ssh hudson@cute-test.com "cd /var/www/iltis && mkdir -p testing"'
    - 'scp -r ch.hsr.ifs.iltis.testing.update/target/repository/* hudson@cute-test.com:/var/www/iltis/testing'
    - 'ssh hudson@cute-test.com "cd /var/www/iltis && compile-composite-updatesite  ILTIS 0.1.0"'
